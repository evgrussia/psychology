# Tech Spec Implementation Rules (обязательная полнота реализации)

## Цель
Если пользователь просит **реализовать техспеку/фичу** (например `FEAT-*` или путь из `docs/generated/tech-specs/`), агент обязан выполнить **всю техспеку целиком** (в пределах заявленного scope) и подтвердить готовность объективными проверками.

Эти правила дополняют существующие:
- Clean Architecture + DDD (`architecture-rules.mdc`)
- Code quality (`code-rules.mdc`)
- Testing rules (`testing-rules.mdc`)
- Documentation rules (`documentation-rules.mdc`)

---

## 1) Когда эти правила обязательны (trigger)
Считать задачу “реализация техспеки” если в запросе пользователя есть хотя бы одно:
- упоминание `FEAT-...` (например `FEAT-BKG-02`)
- ссылка на файл из `docs/generated/tech-specs/*.md`
- формулировки “реализуй техспеку/спеку/feature tech spec/AC/DoD”

В таком случае агент **не имеет права**:
- “частично реализовать” и остановиться без явного “slicing” из техспеки
- завершить работу, не закрыв все Acceptance Criteria / DoD из техспеки

---

## 2) Обязательное чтение перед кодом (нельзя пропускать)
Перед любыми правками кода агент обязан:
- открыть техспеку целевой фичи из `docs/generated/tech-specs/` (и индекс `docs/generated/tech-specs/README.md` — если нужно найти файл/связи)
- прочитать **все** документы, на которые ссылается техспека (tracking plan, модель данных, security/privacy/a11y, интеграционные гайды и т.п.)
- явно выписать:
  - **Acceptance Criteria / Definition of Done**
  - **зависимости** на другие фичи/модули/миграции/инфраструктуру
  - **ограничения** (privacy, security, a11y, observability, idempotency, rate limits)
  - **test plan**, указанный в техспеке

Если для выполнения требуются **секреты/ключи/учётки/неизвестные env vars** (Google/ЮKassa/TG/SMTP и т.п.) — агент обязан запросить их у пользователя и/или реализовать безопасные заглушки **только если это прямо разрешено техспекой**.

---

## 3) Обязательная декомпозиция (todo/чеклист)
Для каждой реализации техспеки агент обязан создать структурированный чеклист (todo) и поддерживать его актуальным:
- **каждый пункт техспеки → отдельная задача** (как минимум по разделам: Domain, Application, Infrastructure, Presentation, DB/migrations, API contracts, Tests, Docs)
- отдельные задачи для:
  - негативных сценариев/деградаций
  - privacy checks (нет PII/текста в аналитике/логах)
  - security (RBAC, аудит, идемпотентность, шифрование где требуется)
  - observability (логи/метрики/алерты где указано)
  - a11y (если есть UI)

Запрещено помечать задачу “готово”, пока не выполнены **все** подпункты техспеки для неё.

---

## 4) Slices/этапы (если техспека “большая”)
Если в техспеке есть **implementation slices/этапы**, агент обязан:
- реализовывать строго **по slice-плану** (A→B→C…)
- после каждого slice:
  - зафиксировать, что именно сделано и что осталось
  - убедиться, что проект собирается и проверки проходят (см. раздел 6)
  - не расширять scope за пределы slice

Запрещено “перепрыгивать” slice’ы или смешивать их требования.

---

## 5) Полнота = соответствие контракту техспеки
Техспека — это контракт. Агент обязан реализовать:
- все эндпойнты/страницы/компоненты/доменную модель, указанные в техспеке
- все бизнес-правила и ограничения, описанные в техспеке
- все события аналитики **строго по `docs/Tracking-Plan.md`** (никаких PII/свободного текста)
- все требования к безопасности и приватности (включая P2-шифрование, если относится к фиче)
- все требования к деградациям при сбоях внешних систем

Если какой-то пункт техспеки невозможно реализовать из‑за отсутствующих внешних доступов/инфры:
- агент обязан всё равно реализовать остальное,
- а “недовыполнимое” оформить как **явный блокер** с чётким списком того, что нужно от пользователя.

---

## 6) Обязательная валидация перед завершением задачи
Перед тем как сказать “готово”, агент обязан:
- прогнать линтер/тайпчек/тесты, релевантные изменённым частям (и починить, если сам сломал)
- прогнать тесты из test plan техспеки (unit/integration/e2e, если требуются)
- для интеграций: выполнить live‑проверку, если техспека требует и есть креды (иначе — оформить блокер)

Запрещено завершать задачу:
- с падающими проверками в затронутых пакетах,
- с невыполненными AC/DoD,
- с “TODO: потом доделаю” внутри критичных путей.

---

## 7) Документация по факту реализации (обязательна)
После реализации техспеки агент обязан создать или обновить отчёт:
- `docs/generated/tech-specs/<FEATURE_ID>-Implementation-Report.md` (или существующий report-файл для этой фичи)

Отчёт должен содержать минимум:
- что реализовано (по AC/DoD)
- где в коде основные точки входа (пакеты/модули)
- как запустить/проверить (команды, env vars без секретов)
- что не сделано и почему (если есть блокеры) + что нужно от пользователя

Если добавлен новый report-файл — обновить индекс `docs/generated/tech-specs/README.md` ссылкой на него.

