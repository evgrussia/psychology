# E2E Tests - Phase 7

E2E тесты для критичных пользовательских сценариев согласно спецификации Phase 7.

## Структура

```
e2e/
├── fixtures/              # Тестовые данные
│   ├── users.json
│   ├── services.json
│   └── content.json
├── helpers/              # Вспомогательные функции
│   ├── api.ts           # API хелперы
│   ├── auth.ts          # Аутентификация
│   └── assertions.ts    # Кастомные assertions
├── scenarios/           # P0 сценарии
│   ├── g1-quick-start.spec.ts
│   ├── g2-booking.spec.ts
│   ├── g3-telegram.spec.ts
│   └── g4-admin.spec.ts
└── utils/               # Утилиты
    ├── cleanup.ts       # Очистка данных
    └── seed.ts          # Seed данных
```

## P0 Сценарии

### G1: Быстрый старт пользы
**Путь:** Главная → выбор состояния → запуск интерактива → результат → CTA

**Критерии успеха:**
- LCP p75 ≤ 2.5s для главной
- INP p75 ≤ 200ms для интерактивов
- Результат отображается корректно
- CTA работают (deep links, переходы)

### G2: Запись (Booking Flow)
**Путь:** Выбор услуги → выбор слота → анкета → согласия → оплата → подтверждение

**Критерии успеха:**
- Успешное подтверждение брони при корректных условиях (SLO: 99.5%)
- Защита от гонок (один слот нельзя подтвердить дважды)
- Корректная синхронизация с Google Calendar
- Идемпотентная обработка webhooks
- Время ответа API p95 ≤ 800ms

### G3: Telegram-связка
**Путь:** CTA "получить план/сохранить" → deep link → онбординг → серия/план

**Критерии успеха:**
- Deep link корректно передает контекст
- Онбординг завершается успешно
- Серия доставляется согласно настройкам
- Отписка работает корректно

### G4: Админ-операции
**Путь:** Вход в админку → открытие раздела → выполнение операции → сохранение

**Критерии успеха:**
- RBAC работает корректно (права проверяются на сервере)
- MFA обязательна для админов
- Аудит-лог записывает критичные действия
- Операции выполняются атомарно

## Запуск тестов

### Все E2E тесты
```bash
npm run test:e2e
```

### Конкретный сценарий
```bash
npx playwright test tests/e2e/scenarios/g1-quick-start.spec.ts
```

### С UI (интерактивный режим)
```bash
npm run test:e2e:ui
```

### В режиме отладки
```bash
npm run test:e2e:debug
```

### Только P0 сценарии
```bash
npx playwright test tests/e2e/scenarios/
```

## Переменные окружения

- `STAGING_URL` - URL фронтенда (по умолчанию: http://localhost:3000)
- `PLAYWRIGHT_TEST_BASE_URL` - альтернативная переменная для base URL
- `API_URL` - URL бэкенда API (для API хелперов)

## Требования

- Backend API должен быть запущен и доступен
- Тестовая база данных должна быть настроена
- Тестовые пользователи должны быть созданы (или создаются автоматически)

## Критерии успеха Phase 7

- ✅ **100% pass rate** для P0 тестов
- ✅ **≥95% pass rate** для всех E2E тестов
- ✅ **Время выполнения:** полный набор P0 тестов ≤ 30 минут
- ✅ **Стабильность:** flaky тесты ≤ 2%

## Отчеты

После выполнения тестов отчеты доступны:
- HTML отчет: `playwright-report/index.html`
- JSON отчет: `playwright-report/results.json`
- JUnit отчет: `playwright-report/results.xml`

## Troubleshooting

### Тесты падают с timeout
- Проверьте, что backend API запущен
- Увеличьте timeout в конфигурации Playwright
- Проверьте сетевые подключения

### Тесты не находят элементы
- Убедитесь, что используются правильные `data-testid` атрибуты
- Проверьте, что страница полностью загружена (`waitForLoadState`)
- Используйте `page.waitForSelector` для динамических элементов

### Проблемы с аутентификацией
- Проверьте, что тестовые пользователи существуют в БД
- Убедитесь, что токены корректно устанавливаются в localStorage

---
*Документ создан: Coder Agent*
