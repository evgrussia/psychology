# Спецификация админ-панели психолога «Эмоциональный баланс»

**Версия:** 1.0  
**Дата:** 2026-01-28  
**Источники:** `context/project-brief.yaml`, `docs/research/08-Admin-CRM-Analytics.md`, `docs/Content-Filling-Plan.md`, текущий backend API и use cases.

**Назначение:** максимально возможный набор инструментов для психолога по ведению пациентов — один источник истины для реализации.

---

## 1. Текущее состояние

### 1.1 Фронтенд
- **Админ-панель отсутствует:** в `App.tsx` нет маршрута/страницы `admin`; в `frontend/src/api` нет `endpoints/admin.ts`.
- Личный кабинет клиента (cabinet) есть; отдельная зона для ролей owner/assistant/editor не реализована.

### 1.2 Бэкенд (уже есть)
- **API (только списки):**
  - `GET /api/v1/admin/appointments/` — бронирования (фильтры: status, date_from, date_to, пагинация).
  - `GET /api/v1/admin/leads/` — лиды (status, source, date_from, date_to).
  - `GET /api/v1/admin/content/` — контент (статьи, ресурсы).
  - `GET /api/v1/admin/moderation/` — очередь модерации UGC (status=pending по умолчанию).
- **Use cases (не все выставлены в API):**
  - `GetLeadsListUseCase`, `RecordAppointmentOutcomeAdminUseCase`, `CreateAvailabilitySlotUseCase`, `PublishContentItemUseCase`, `ModerateUGCItemUseCase`, `AnswerUGCQuestionUseCase`.
- **Права:** `IsOwnerOrAssistant` (appointments, leads), `IsOwnerOrEditor` (content, moderation).

### 1.3 Пробелы
- Нет фронтенд-админки (layout, навигация, экраны).
- Нет API для **действий**: запись исхода встречи (attended/no_show/canceled), создание слотов, публикация контента, модерация/ответ на UGC.
- Нет модулей: расписание (календарь/слоты), услуги CRUD, шаблоны сообщений, аналитика/дашборды, аудит-лог, медиа-библиотека, подборки, словарь терминов.

---

## 2. Полный перечень инструментов (по research 08)

Ниже — целевой набор «максимально возможных» инструментов для психолога. Реализация — по фазам.

### 2.1 Роли и доступы
| Роль        | Расписание | Лиды/CRM | Контент | Модерация | Аналитика | Аудит |
|------------|------------|----------|---------|-----------|-----------|-------|
| Owner      | ✓          | ✓        | ✓       | ✓         | ✓         | ✓     |
| Assistant  | ✓          | ✓        | —       | —         | частично  | —     |
| Editor     | —          | —        | ✓       | ✓         | —         | —     |

- Вход в админку: только для ролей owner / assistant / editor (проверка по JWT и роли с бэкенда).

### 2.2 Расписание
- **Слоты:** создание слотов (правила повторения), исключения (отпуск, перерывы).
- **Представления:** календарь (день/неделя), список ближайших встреч.
- **Буферы** между сессиями, длительности по услугам (если есть в домене).
- **Импорт/синхронизация** календаря (опционально, при наличии интеграции).

### 2.3 Услуги
- CRUD услуг.
- Цены, депозиты, пакеты (кол-во встреч, срок).
- Политика переносов/отмен (на уровне услуги или глобально).

### 2.4 CRM — лиды (воронка)
- **Источники:** квиз/тест, подписка Telegram, лист ожидания, анонимный вопрос, запись (booking).
- **Пайплайн:** new → engaged → booking_started → booked_confirmed → paid → completed_session | follow_up_needed | inactive.
- **Карточка лида:** источник/UTM, сегмент (тема), события (timeline), заметка ассистента (не терапевтическая), согласия.
- **Список:** фильтры по статусу, источнику, датам; пагинация (уже есть API).

### 2.5 Встречи (бронирования)
- Список встреч с фильтрами по дате и статусу (API есть).
- **Обязательно:** экран «Исход встречи» — отметка после сессии: attended / no_show / canceled (для метрики no-show rate и аналитики).

### 2.6 Контент (CMS)
- Статьи, микро-заметки, ресурсы (упражнения, аудио, чек-листы), лендинги, страницы «как проходит» / «обо мне».
- Редактор + QA-чеклист перед публикацией (дисклеймер, тон, первый шаг, CTA, перелинковка 2–5).
- **Подборки контента** (`/curated/`): создание, порядок (drag & drop), категории.
- **Словарь терминов** (`/glossary/`): CRUD, категории, markdown, перелинковка, синонимы.
- **Медиа-библиотека:** загрузка изображений/аудио/PDF, папки/теги, превью, выбор в контенте.

### 2.7 Интерактивы (настройка без кода)
- Тексты вопросов, шкалы/варианты, уровни результата и рекомендации, CTA.
- Пороги уровней (low/moderate/high), скрипты границ (BND-01), мини-ритуалы, настройки навигатора.
- Превью интерактива «как видит пользователь» перед публикацией.
- Безопасность: логирование без чувствительных текстов, кризисные триггеры → обязательный сценарий.

### 2.8 Шаблоны сообщений (email / Telegram)
- Типы: подтверждение записи, напоминания, «как подготовиться», материалы после сессии, «нет слотов» → лист ожидания.
- Переменные (имя, время, ссылка), версия и история изменений.

### 2.9 Модерация UGC
- Очередь: pending/flagged вопросы (API list есть).
- Действия: одобрить, отклонить, ответить (use case есть).
- Дашборд модерации: время модерации (<24 ч обычные, <4 ч кризис), доля отклонённых, доля кризисных, жалобы.
- Согласия: публикация, уровень анонимности, отзыв согласия.

### 2.10 Аналитика и дашборды
- **KPI:** visit → booking, visit → TG subscribe, engage → lead, возвраты (дневники/челлендж), no-show rate, retention D1/D7/D30.
- **Дашборды:** воронка (посещения → интерактив → TG → запись → оплата), каналы, темы, интерактивы (completion rate, CTA), слоты (загрузка, no-show), модерация UGC, контент (популярность, CTA), мероприятия, финансы (GMV, AOV).

### 2.11 Аудит-лог
- Кто и когда изменил цены/политику, экспорт данных, удаление записей (если доступно).

---

## 3. Фазы реализации (рекомендуемые)

### Фаза 1 — Минимальная рабочая админка (MVP)
**Цель:** психолог может заходить в админку и вести пациентов по базовым сценариям.

1. **Фронтенд**
   - Отдельный layout админки: боковое меню (или верхнее), контейнер контента.
   - Маршрут входа: только для пользователей с ролью owner/assistant/editor (проверка после логина; при отсутствии роли — редирект в кабинет или главную).
   - Страницы:
     - **Дашборд:** сводка (количество лидов за период, ближайшие встречи, очередь модерации).
     - **Встречи:** список бронирований (данные из `GET admin/appointments/`), фильтры по дате/статусу. Кнопка/форма «Исход встречи» (attended / no_show / canceled) → вызов API (нужно добавить endpoint).
     - **Лиды:** список лидов из `GET admin/leads/` с фильтрами; карточка лида (детали, timeline — по мере появления API).
     - **Контент:** список из `GET admin/content/` с переходом к редактированию/публикации (если есть API publish — иначе только просмотр).
     - **Модерация:** список из `GET admin/moderation/`, действия «одобрить»/«отклонить»/«ответить» (нужны endpoints для moderate и answer).
2. **Бэкенд**
   - `POST /api/v1/admin/appointments/<id>/record_outcome/` (body: `{ outcome: "attended" | "no_show" | "canceled" }`) → `RecordAppointmentOutcomeAdminUseCase`.
   - `POST /api/v1/admin/moderation/<id>/moderate/` (body: status, comment?) → `ModerateUGCItemUseCase`.
   - `POST /api/v1/admin/moderation/<id>/answer/` (body: text) → `AnswerUGCQuestionUseCase`.
   - При необходимости: `POST /api/v1/admin/content/<id>/publish/` → `PublishContentItemUseCase`.
3. **Фронтенд API-клиент**
   - `frontend/src/api/endpoints/admin.ts`: методы для appointments, leads, content, moderation + вызовы новых действий (record_outcome, moderate, answer, publish).
   - Типы в `frontend/src/api/types/admin.ts`.

### Фаза 2 — Расписание и слоты
- Экран «Расписание»: календарь (день/неделя), список слотов.
- Создание слотов: форма → `CreateAvailabilitySlotUseCase` (нужен endpoint `POST /api/v1/admin/slots/` или аналог).
- Исключения (отпуск): по возможности в том же экране или отдельная настройка.

### Фаза 3 — Услуги и шаблоны сообщений
- CRUD услуг (если в API есть или добавить).
- Шаблоны сообщений (email/TG): список, редактирование, переменные, история.

### Фаза 4 — Контент расширенный
- Редактор статей/ресурсов (полноценный CMS), медиа-библиотека, подборки, словарь терминов.
- QA-чеклист перед публикацией.

### Фаза 5 — Интерактивы и аналитика
- Настройка квизов/ритуалов/навигатора (вопросы, пороги, CTA), превью.
- Дашборды аналитики (воронка, каналы, темы, no-show, retention).
- Аудит-лог (просмотр событий).

---

## 4. Ожидаемые артефакты (Фаза 1)

| Артефакт | Описание |
|----------|----------|
| `frontend/src/app/AdminLayout.tsx` | Layout админки (сайдбар/нав, проверка роли). |
| `frontend/src/app/components/admin/AdminDashboard.tsx` | Дашборд (сводка). |
| `frontend/src/app/components/admin/AdminAppointments.tsx` | Список встреч + форма «Исход встречи». |
| `frontend/src/app/components/admin/AdminLeads.tsx` | Список лидов. |
| `frontend/src/app/components/admin/AdminContent.tsx` | Список контента. |
| `frontend/src/app/components/admin/AdminModeration.tsx` | Очередь модерации + действия. |
| `frontend/src/api/endpoints/admin.ts` | API-клиент админки. |
| `frontend/src/api/types/admin.ts` | Типы. |
| `frontend/src/app/App.tsx` | Маршрут `admin` и подмаршруты (или состояние `currentPage === 'admin'` с подстраницами). |
| Backend: `admin/appointments/<id>/record_outcome/`, `admin/moderation/<id>/moderate/`, `admin/moderation/<id>/answer/` | Новые endpoints. |

---

## 5. Роутинг задач (Orchestrator)

| Задача | Агент | Действие |
|--------|--------|----------|
| Детализация UX админки (навигация, карточка лида, форма исхода встречи) | UX | Уточнить флоу и экраны по п.2–3. |
| Проверка контракта API и дизайн недостающих endpoints | Architect / Dev | Описать в `docs/api/api-contracts.md` admin actions; при необходимости ADR. |
| Реализация backend endpoints (record_outcome, moderate, answer, publish) | Coder | ViewSet actions + сериализаторы. |
| Реализация фронтенд админки (layout, дашборд, встречи, лиды, контент, модерация) | Coder | Компоненты + интеграция с API. |
| Верификация по спекам | Review / QA | 100% по данной спецификации. |

---

*Документ создан: Orchestrator Agent*
