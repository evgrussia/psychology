# Модель данных — «Эмоциональный баланс» (Release 1)

**Версия:** v1.0 (draft)  
**Дата:** 2026-01-07  
**Основано на:** `docs/PRD.md`, `docs/Tracking-Plan.md`, `docs/Admin-Panel-Specification.md`, `docs/Telegram-Deep-Links-Schema.md`, `docs/UGC-Moderation-Rules.md`, `docs/research/05-Booking-Payment-ClientCabinet.md`, `docs/research/08-Admin-CRM-Analytics.md`, `docs/research/10-Legal-Privacy-Compliance-RU.md`, `docs/Interactive-Modules-Matrix.md`.

Документ фиксирует **физическую модель данных продукта**: таблицы БД, ключи, ограничения и принципы хранения/минимизации данных.

**Важно:** Этот документ описывает **физическую схему БД (persistence layer)**. Для логической доменной модели с Aggregate Roots, Entities, Value Objects и Domain Events см. **`docs/Domain-Model-Specification.md`**.

---

## 0) Принципы модели данных (обязательные)

### Privacy by design (must-have)
- **Не храним и не отправляем в аналитику**: тексты дневников, ответы анкеты, тексты анонимных вопросов, свободный текст интерактивов, сырые ответы квизов.  
  Источник: `docs/Tracking-Plan.md`, `docs/research/10-*`.
- Для интерактивов сохраняем **только агрегаты** (например, `result_level=low|moderate|high`, `result_profile`) и технические метаданные.
- Платёжные реквизиты **не храним** (только `provider_payment_id`, статус и суммы). Источник: PRD `FR-PAY-*`.

### Общие соглашения по полям
- **PK**: `id` (UUID v4) или ULID (если нужен сортируемый ID). Для некоторых доменов допустимы короткие `*_id` (base62) — например, `deep_link_id`.
- **Время**: храним в UTC: `created_at`, `updated_at`, `deleted_at` (soft delete где нужно).
- **Slug**: `slug` — уникален **в пределах типа** (контент/услуги/мероприятия/термины).
- **Статусы**: enum/справочник (не “свободная строка”).

### Классификация данных (для проектирования доступа/шифрования)
- **P0 (safe)**: технические идентификаторы, UTM, slug, агрегаты `result_level`.
- **P1 (PII)**: `email`, `phone`, `telegram_*`, имя.
- **P2 (sensitive)**: дневники, анкеты, тексты UGC (анонимный вопрос/отзыв), любые признаки кризиса как содержание (мы храним только **категории/флаги**, не детали).

---

## 1) Границы (bounded contexts) и «ядро» сущностей

### Домены релиза 1
- **Identity & Access**: пользователи, роли, согласия.
- **Content**: статьи/ресурсы/лендинги/служебные страницы, теги/темы, подборки, словарь.
- **Interactive**: определения интерактивов (квизы/навигатор/термометр/скрипты/ритуалы), агрегированные результаты.
- **Booking & Payments**: услуги, слоты/расписание, встречи, оплаты, анкета, лист ожидания.
- **Client Cabinet**: дневники, экспорт PDF, управление данными.
- **Telegram**: deep links, склейка по `deep_link_id`.
- **CRM & Analytics**: лиды, таймлайн событий (без чувствительных текстов).
- **UGC Moderation**: анонимные вопросы/отзывы, статусы, модерация, ответы, согласия на публикацию.
- **Admin & Audit**: админские пользователи, аудит‑лог, шаблоны сообщений.

---

## 2) ER-диаграммы (обзор)

Ниже — ER‑диаграммы по доменам. Это **логическая** модель (сущности/связи); физическая схема БД (типы/индексы) выводится из неё.

---

## 2.1 Identity & Access (пользователи, роли, согласия)

```mermaid
erDiagram
  USERS ||--o{ USER_ROLES : has
  ROLES ||--o{ USER_ROLES : includes
  USERS ||--o{ CONSENTS : grants

  USERS {
    uuid id PK
    text email "P1, unique nullable"
    text phone "P1, unique nullable"
    text telegram_user_id "P1, unique nullable"
    text telegram_username "P1 nullable"
    text display_name "P1 nullable"
    text status "active|blocked|deleted"
    timestamptz created_at
    timestamptz updated_at
    timestamptz deleted_at
  }

  ROLES {
    text code PK "owner|assistant|editor|client"
    text scope "admin|product"
  }

  USER_ROLES {
    uuid user_id FK
    text role_code FK
    timestamptz granted_at
  }

  CONSENTS {
    uuid id PK
    uuid user_id FK
    text consent_type "personal_data|communications|telegram|review_publication"
    boolean granted
    text version "например, 2026-01-07"
    text source "web|telegram|admin"
    timestamptz granted_at
    timestamptz revoked_at
  }
```

### Ключевые ограничения
- **`users.email`** уникален, допускает NULL (если логин через magic link/Telegram ещё не привязан).
- **`users.telegram_user_id`** уникален, допускает NULL (связка TG ↔ user опциональна, источник: `docs/research/10-*`).
- **RBAC**: доступ к P2 данным (анкеты/дневники/UGC тексты) только ролям `owner/assistant` (и то по необходимости).

---

## 2.2 Content (CMS, темы/теги, подборки, словарь, медиа)

```mermaid
erDiagram
  USERS ||--o{ CONTENT_ITEMS : authors
  CONTENT_ITEMS ||--o{ CONTENT_ITEM_TOPICS : has
  TOPICS ||--o{ CONTENT_ITEM_TOPICS : includes
  CONTENT_ITEMS ||--o{ CONTENT_ITEM_TAGS : has
  TAGS ||--o{ CONTENT_ITEM_TAGS : includes
  MEDIA_ASSETS ||--o{ CONTENT_MEDIA : used_in
  CONTENT_ITEMS ||--o{ CONTENT_MEDIA : references

  CURATED_COLLECTIONS ||--o{ CURATED_ITEMS : contains
  CONTENT_ITEMS ||--o{ CURATED_ITEMS : may_include
  INTERACTIVE_DEFINITIONS ||--o{ CURATED_ITEMS : may_include

  GLOSSARY_TERMS ||--o{ GLOSSARY_TERM_SYNONYMS : has
  GLOSSARY_TERMS ||--o{ GLOSSARY_TERM_LINKS : links_to
  CONTENT_ITEMS ||--o{ GLOSSARY_TERM_LINKS : referenced_by

  CONTENT_ITEMS {
    uuid id PK
    text content_type "article|note|resource|landing|page"
    text slug "unique (content_type, slug)"
    text title
    text excerpt
    text body_markdown
    text status "draft|review|published|archived"
    timestamptz published_at
    uuid author_user_id FK
    text time_to_benefit "1_3_min|7_10_min|20_30_min|series"
    text format "article|note|resource|audio|checklist"
    text support_level "self_help|micro_support|consultation"
    timestamptz created_at
    timestamptz updated_at
  }

  TOPICS {
    text code PK "anxiety|burnout|relationships|boundaries|selfesteem|..."
    text title
    boolean is_active
  }

  TAGS {
    uuid id PK
    text slug "unique"
    text title
  }

  CONTENT_ITEM_TOPICS {
    uuid content_item_id FK
    text topic_code FK
  }

  CONTENT_ITEM_TAGS {
    uuid content_item_id FK
    uuid tag_id FK
  }

  MEDIA_ASSETS {
    uuid id PK
    text storage_provider "local_fs"
    text object_key "unique (relative path under media root)"
    text public_url
    text media_type "image|audio|pdf"
    text mime_type
    bigint size_bytes
    text title
    text alt_text
    uuid uploaded_by_user_id FK
    timestamptz created_at
  }

  CONTENT_MEDIA {
    uuid content_item_id FK
    uuid media_asset_id FK
    text usage "cover|inline|attachment|audio"
  }

  CURATED_COLLECTIONS {
    uuid id PK
    text slug "unique"
    text title
    text collection_type "problem|format|goal|context"
    text status "draft|published|archived"
    text topic_code "nullable (any)"
    timestamptz published_at
  }

  CURATED_ITEMS {
    uuid id PK
    uuid collection_id FK
    text item_type "content|interactive"
    uuid content_item_id FK "nullable"
    uuid interactive_definition_id FK "nullable"
    int position
    text note "nullable"
  }

  GLOSSARY_TERMS {
    uuid id PK
    text slug "unique"
    text title
    text category "approach|state|concept"
    text short_definition
    text body_markdown
    text status "draft|published|archived"
    timestamptz published_at
  }

  GLOSSARY_TERM_SYNONYMS {
    uuid id PK
    uuid term_id FK
    text synonym
  }

  GLOSSARY_TERM_LINKS {
    uuid id PK
    uuid term_id FK
    uuid content_item_id FK
    text link_type "mentioned_in|recommended"
  }
```

### Ключевые ограничения
- `content_items.slug` уникален в паре **(`content_type`, `slug`)**.
- `curated_items` — XOR‑связь: заполнено либо `content_item_id`, либо `interactive_definition_id` (не оба).
- `media_assets.object_key` уникален; метаданные (`alt_text`) обязательны для изображений (A11y).

---

## 2.3 Interactive (определения интерактивов + агрегированные результаты)

> В релизе 1 интерактивы должны работать **без обязательной авторизации** (см. `docs/Technical-Decisions.md`), но для CRM/аналитики полезно хранить агрегаты прохождения **без сырых ответов**.

```mermaid
erDiagram
  TOPICS ||--o{ INTERACTIVE_DEFINITIONS : categorizes
  INTERACTIVE_DEFINITIONS ||--o{ INTERACTIVE_RUNS : has
  USERS ||--o{ INTERACTIVE_RUNS : may_have

  INTERACTIVE_DEFINITIONS {
    uuid id PK
    text interactive_type "quiz|navigator|thermometer|boundaries|prep|ritual"
    text slug "unique (interactive_type, slug)"
    text title
    text topic_code "nullable"
    text status "draft|published|archived"
    timestamptz published_at
  }

  INTERACTIVE_RUNS {
    uuid id PK
    uuid interactive_definition_id FK
    uuid user_id FK "nullable"
    text anonymous_id "nullable, P0"
    timestamptz started_at
    timestamptz completed_at
    text result_level "low|moderate|high nullable"
    text result_profile "nullable (navigator)"
    integer duration_ms
    text deep_link_id "nullable"
  }
```

### Ключевые ограничения
- `interactive_runs` **не содержит**: сырые ответы, тексты выборов, свободный текст.
- Связь `user_id` *или* `anonymous_id` (можно хранить оба, если авторизация произошла во время сессии, но без PII).
- Если требуется редактируемость интерактивов в админке “без кода”, физическая модель расширяется под конкретные типы (квиз‑вопросы/пороги, сценарии скриптов границ, библиотека ритуалов). Это можно оформлять отдельными таблицами по типам, не меняя общего `interactive_definitions`.

---

## 2.4 Booking & Payments (услуги, слоты, встречи, оплаты, анкета, лист ожидания)

```mermaid
erDiagram
  SERVICES ||--o{ APPOINTMENTS : scheduled_for
  USERS ||--o{ APPOINTMENTS : client
  APPOINTMENTS ||--o{ PAYMENTS : paid_by
  SERVICES ||--o{ AVAILABILITY_SLOTS : offered
  USERS ||--o{ WAITLIST_REQUESTS : requests
  SERVICES ||--o{ WAITLIST_REQUESTS : for
  APPOINTMENTS ||--o{ INTAKE_FORMS : has

  SERVICES {
    uuid id PK
    text slug "unique"
    text title
    text description_markdown
    text format "online|offline|hybrid"
    integer duration_minutes
    integer price_amount "RUB"
    integer deposit_amount "nullable"
    integer cancel_free_hours "nullable"
    text status "draft|published|archived"
    timestamptz created_at
    timestamptz updated_at
  }

  AVAILABILITY_SLOTS {
    uuid id PK
    uuid service_id FK "nullable (any service)"
    timestamptz start_at_utc
    timestamptz end_at_utc
    text status "available|reserved|blocked"
    text source "product|google_calendar"
    text external_event_id "nullable"
    timestamptz created_at
  }

  APPOINTMENTS {
    uuid id PK
    uuid service_id FK
    uuid client_user_id FK "nullable (если ещё lead)"
    uuid lead_id "nullable"
    timestamptz start_at_utc
    timestamptz end_at_utc
    text timezone "IANA"
    text format "online|offline"
    text status "pending_payment|paid|confirmed|canceled|rescheduled|completed"
    text meeting_url "nullable"
    text location_text "nullable"
    uuid slot_id FK "nullable"
    text external_calendar_event_id "nullable"
    timestamptz created_at
    timestamptz updated_at
  }

  PAYMENTS {
    uuid id PK
    uuid appointment_id FK
    text provider "yookassa"
    text provider_payment_id "unique"
    integer amount
    text currency "RUB"
    text status "pending|succeeded|canceled|failed"
    text failure_category "nullable"
    timestamptz created_at
    timestamptz confirmed_at
  }

  INTAKE_FORMS {
    uuid id PK
    uuid appointment_id FK
    text status "draft|submitted"
    text payload_encrypted "P2"
    timestamptz submitted_at
  }

  WAITLIST_REQUESTS {
    uuid id PK
    uuid user_id FK "nullable"
    uuid service_id FK
    text preferred_contact "email|phone|telegram"
    text contact_value_encrypted "P1"
    text preferred_time_window "nullable"
    text status "new|contacted|closed"
    timestamptz created_at
  }
```

### Ключевые ограничения (критичные для корректности)
- **Защита от конфликтов бронирования** (PRD `FR-BKG-7`):
  - уникальность по времени в `appointments` на уровне “провайдера расписания” (минимум: `UNIQUE(start_at_utc)` в рамках одной занятости владельца, плюс транзакционная блокировка слота).
  - `availability_slots.status` должен переходить `available → reserved` атомарно (optimistic/pessimistic lock).
- `payments.provider_payment_id` уникален (идемпотентность вебхуков).
- `intake_forms.payload_encrypted` хранится шифрованно, доступ только `owner` (и опционально `assistant`), не участвует в аналитике.

---

## 2.5 Client Cabinet (дневники, экспорт PDF, удаление данных)

```mermaid
erDiagram
  USERS ||--o{ DIARY_ENTRIES : writes
  USERS ||--o{ DATA_EXPORT_REQUESTS : requests

  DIARY_ENTRIES {
    uuid id PK
    uuid user_id FK
    text diary_type "emotions|abc|sleep_energy|gratitude"
    date entry_date
    text payload_encrypted "P2"
    timestamptz created_at
    timestamptz deleted_at
  }

  DATA_EXPORT_REQUESTS {
    uuid id PK
    uuid user_id FK
    text export_type "user_data|diary_pdf"
    text status "requested|processing|ready|failed"
    text file_url "nullable"
    timestamptz created_at
    timestamptz completed_at
  }
```

### Ключевые ограничения
- Дневники — **приватные по умолчанию** (см. `docs/UGC-Moderation-Rules.md`), не видны никому кроме пользователя (без отдельного механизма “поделиться”).
- Удаление дневников — физическое или soft delete по политике хранения, но **пользовательский UX** должен гарантировать “удалено” (PRD `FR-LK-2`).

---

## 2.6 Telegram & deep links (склейка Web ↔ Telegram)

```mermaid
erDiagram
  DEEP_LINKS ||--o{ LEAD_TIMELINE_EVENTS : used_in

  DEEP_LINKS {
    text deep_link_id PK
    text flow "plan_7d|save_resource|challenge_7d|concierge|question|prep|ritual|boundaries|favorites"
    text topic_code "nullable"
    text entity_ref "nullable (resource/quiz/ritual id/slug)"
    text source_page "home|quiz|navigator|landing|article|..."
    text anonymous_id "nullable"
    uuid lead_id "nullable"
    timestamptz created_at
    timestamptz expires_at "TTL=30d (рекоменд.)"
  }
```

### Ограничения
- Payload deep link **не содержит PII и текстов** (см. `docs/Telegram-Deep-Links-Schema.md`).
- TTL: 30 дней достаточно для аналитики и дебага (см. тот же документ).

---

## 2.7 CRM & Analytics (лиды, таймлайн событий без текстов)

```mermaid
erDiagram
  USERS ||--o{ LEADS : may_be
  LEADS ||--o{ LEAD_IDENTITIES : has
  LEADS ||--o{ LEAD_TIMELINE_EVENTS : timeline
  DEEP_LINKS ||--o{ LEAD_TIMELINE_EVENTS : correlates

  LEADS {
    uuid id PK
    text status "new|engaged|booking_started|booked_confirmed|paid|completed_session|follow_up_needed|inactive"
    text source "quiz|telegram|waitlist|question|booking"
    text topic_code "nullable"
    jsonb utm "nullable"
    timestamptz created_at
    timestamptz updated_at
  }

  LEAD_IDENTITIES {
    uuid id PK
    uuid lead_id FK
    uuid user_id FK "nullable"
    text anonymous_id "nullable"
    text email_encrypted "nullable, P1"
    text phone_encrypted "nullable, P1"
    text telegram_user_id "nullable, P1"
    boolean is_primary
    timestamptz created_at
  }

  LEAD_TIMELINE_EVENTS {
    uuid id PK
    uuid lead_id FK
    text event_name "из Tracking Plan"
    text source "web|backend|telegram|admin"
    timestamptz occurred_at
    text deep_link_id "nullable"
    jsonb properties "P0-only, без PII/текстов"
  }
```

### Ограничения
- `lead_timeline_events.properties` проходит “валидатор запрета” (PII/тексты) по правилам `docs/Tracking-Plan.md`.
- Лид создаётся при первом “контактном” событии (waitlist/booking/intake/telegram link) — источник: `docs/Tracking-Plan.md`.

---

## 2.8 UGC Moderation (анонимные вопросы, отзывы, модерация, ответы, согласия)

```mermaid
erDiagram
  USERS ||--o{ UGC_MODERATION_ACTIONS : moderates
  ANONYMOUS_QUESTIONS ||--o{ UGC_MODERATION_ACTIONS : has
  ANONYMOUS_QUESTIONS ||--o{ QUESTION_ANSWERS : answered_by
  REVIEWS ||--o{ REVIEW_PUBLICATION_CONSENTS : consented_by

  ANONYMOUS_QUESTIONS {
    uuid id PK
    uuid user_id FK "nullable"
    text status "pending|flagged|approved|answered|rejected"
    text trigger_flags "nullable (crisis|pii|medical|spam)"
    text question_text_encrypted "P2"
    text contact_value_encrypted "nullable, P1"
    boolean publish_allowed "default false"
    timestamptz submitted_at
    timestamptz answered_at
  }

  QUESTION_ANSWERS {
    uuid id PK
    uuid question_id FK
    uuid answered_by_user_id FK
    text answer_text_encrypted "P2"
    timestamptz published_at
  }

  UGC_MODERATION_ACTIONS {
    uuid id PK
    text ugc_type "anonymous_question|review|comment"
    uuid ugc_id
    uuid moderator_user_id FK
    text action "approve|reject|flag|mask_pii|publish|unpublish|escalate"
    text reason_category "crisis|medical|out_of_scope|therapy_request|spam|pii|other"
    timestamptz created_at
  }

  REVIEWS {
    uuid id PK
    uuid user_id FK "nullable"
    text status "draft|pending|published|unpublished"
    text review_text_encrypted "P2"
    text anonymity_level "full|initials|named"
    timestamptz submitted_at
    timestamptz published_at
  }

  REVIEW_PUBLICATION_CONSENTS {
    uuid id PK
    uuid review_id FK
    uuid user_id FK "nullable"
    boolean granted
    text version
    timestamptz granted_at
    timestamptz revoked_at
  }
```

### Ограничения
- Для UGC действуют SLA/статусы и кризис‑процедуры из `docs/UGC-Moderation-Rules.md`.
- Публикация отзывов/кейсов — только при наличии согласия и возможности отзыва (см. PRD `FR-TRUST-3`).

---

## 2.9 Admin & Audit (аудит‑лог, шаблоны сообщений)

```mermaid
erDiagram
  USERS ||--o{ AUDIT_LOG : acts
  MESSAGE_TEMPLATES ||--o{ MESSAGE_TEMPLATE_VERSIONS : versions

  AUDIT_LOG {
    uuid id PK
    uuid actor_user_id FK
    text actor_role "owner|assistant|editor"
    text action "admin_price_changed|admin_data_exported|admin_content_published|..."
    text entity_type "service|content|lead|user|payment|..."
    uuid entity_id "nullable"
    jsonb old_value "nullable"
    jsonb new_value "nullable"
    text ip_address "nullable"
    text user_agent "nullable"
    timestamptz created_at
  }

  MESSAGE_TEMPLATES {
    uuid id PK
    text channel "email|telegram"
    text category "booking|waitlist|event|moderation"
    text name
    text status "draft|active|archived"
    timestamptz created_at
  }

  MESSAGE_TEMPLATE_VERSIONS {
    uuid id PK
    uuid template_id FK
    int version
    text subject "nullable"
    text body_markdown
    uuid updated_by_user_id FK
    timestamptz created_at
  }
```

### Ограничения
- Аудит‑лог обязателен для критичных действий (цены, экспорт данных, удаления) — см. PRD `FR-ADM-5`.
- Хранение audit‑лога: минимум 3 года (требование из админ‑спеки; уточняется юристом).

---

## 3) Сущности и ключевые бизнес-ограничения (короткий перечень)

### Запись/оплата
- **`services`**: формат, длительность, цена/депозит, правила отмены.
- **`availability_slots`**: доступные интервалы времени, источник (product/google_calendar), статус.
- **`appointments`**: встреча клиента; статусы должны быть согласованы с backend‑истиной (`booking_paid`, `booking_confirmed`).
- **`payments`**: идемпотентность по `provider_payment_id`, источник истины — webhook провайдера.

### Контент
- **`content_items`**: единый типизированный контент с markdown; публикация через статус.
- **`topics/tags`**: таксономия сквозная (для контента, интерактивов, аналитики).
- **`curated_collections`** и **`glossary_terms`** — включены в релиз 1 (см. `docs/Technical-Decisions.md`).

### Интерактивы
- Общая сущность **`interactive_definitions`** + агрегаты **`interactive_runs`**.
- Конкретные “редакторы” (квиз/ритуалы/скрипты) добавляются отдельными таблицами, но сохраняют принцип: **никаких сырых ответов/текстов в аналитике**.

### CRM/лиды и аналитика
- **`leads`**: создаются при первом “контактном” событии.
- **`lead_timeline_events`**: хранит события по tracking plan, но **строго без PII/текстов**.
- **`deep_links`**: TTL 30 дней, ключ склейки `deep_link_id`.

### UGC
- Все тексты UGC (вопросы/ответы/отзывы) — P2, шифрование + ограничение доступов.
- Публикация отзывов — только при наличии согласия и возможности отзыва.

---

## 4) Рекомендации по индексации (минимум для релиза 1)

- `content_items (content_type, slug)` UNIQUE
- `services (slug)` UNIQUE
- `glossary_terms (slug)` UNIQUE
- `curated_collections (slug)` UNIQUE
- `payments (provider, provider_payment_id)` UNIQUE
- `appointments (start_at_utc)` + индекс по `status`
- `availability_slots (start_at_utc, status)` + индекс по `source`
- `lead_timeline_events (lead_id, occurred_at)` индекс
- `deep_links (deep_link_id)` PK + индекс по `created_at` (для TTL очистки)

---

## 5) Политики хранения (TTL) — минимально необходимое

> Конкретные сроки финализируются юристом, но технически мы должны поддерживать TTL/удаление.

- **`deep_links`**: TTL 30 дней (аналитика/склейка).
- **`interactive_runs`**: TTL 30–90 дней (или хранить только для агрегатов/CRM), без сырых ответов.
- **`anonymous_questions`**: TTL 90 дней после ответа (как в матрице интерактивов) или удаление по запросу.
- **`diary_entries`**: пока аккаунт активен, с возможностью удаления пользователем в любой момент.
- **`audit_log`**: 3 года (минимум) — как требование админки.

