# Техническая спецификация фичи (Tech Spec)

**Проект:** «Эмоциональный баланс»  
**Версия спеки:** v0.1 (draft)  
**Автор:** Cursor Agent  
**Дата:** 2026-01-07  
**Статус:** draft  

**Feature ID:** `FEAT-PLT-01`  
**Epic:** `EPIC-00`  
**Приоритет:** P0  
**Трекер:** —  

**Оценка реализации агентом Cursor:** ~110k токенов (≤ 270k)

---

## 1) Summary (коротко)

### 1.1 Что делаем
Создаём “скелет” репозитория и инфраструктуру разработки: монорепо (web/admin/api/bot), базовые стандарты, CI/CD пайплайны и окружения dev/stage/prod, чтобы безопасно и быстро реализовывать фичи из `docs/Roadmap-Backlog.md`.

### 1.2 Почему сейчас (контекст / метрики / риск)
- **Сигнал/боль:** без каркаса любое P0 развитие блокируется, нет воспроизводимого окружения и деплоя.
- **Ожидаемый эффект:** сокращение времени на интеграции/релизы, снижение регресса, наблюдаемость.
- **Если не сделать:** хаотичные зависимости, утечки секретов, невозможность стабильно тестировать booking/payments/webhooks.

### 1.3 Ссылки на первоисточники
- PRD: `docs/PRD.md` (NFR-SEC/NFR-AN)
- Архитектура: `docs/Архитектурный-обзор.md` (Clean Architecture)
- Roadmap: `docs/Roadmap-Backlog.md` (EPIC-00)
- NFR: `docs/NFR-SLO-SLI-Performance-Security-Scalability.md`

---

## 2) Goals / Non-goals

### 2.1 Goals (что обязательно)
- **G1:** Единая структура репо под Clean Architecture и DDD (разделение `domain/application/infrastructure/presentation` для backend).
- **G2:** Воспроизводимый локальный запуск: Postgres (+ опционально Redis) в Docker, web/admin/api/bot запускаются одной командой.
- **G3:** CI пайплайн: lint/typecheck/tests/build на PR; минимальные security checks (secret scan, dependency audit).
- **G4:** CD (stage/prod): деплой web+api+bot, миграции, healthchecks.
- **G5:** Управление конфигурацией/секретами по окружениям (dev/stage/prod) без коммита секретов.

### 2.2 Non-goals (что осознанно НЕ делаем)
- **NG1:** Полная инфраструктура A/B тестирования (это `FEAT-AB-01`, P2).
- **NG2:** Полноценный SRE-стек (Prometheus/Grafana) — только минимум для релиза 1 (`FEAT-AN-03`).

---

## 3) Scope (границы и сценарии)

### 3.1 In-scope (конкретные сценарии)
- **US-1:** Разработчик поднимает проект локально за ≤15 минут по инструкции.
- **US-2:** PR в main проходит проверки и даёт артефакты сборки.
- **US-3:** Stage окружение обновляется предсказуемо (миграции + smoke).

### 3.2 Out-of-scope
- Настройка конкретного облака “под ключ” (Yandex/VK/AWS) — допускается абстракция с примером; детали уточняются в деплой-доках.

### 3.3 Acceptance criteria (AC)
- [ ] AC-1 Есть монорепо-структура для web/admin/api/bot.
- [ ] AC-2 Есть `docker-compose` для локальной БД и командный запуск сервисов.
- [ ] AC-3 CI запускается автоматически и валит PR при ошибках.
- [ ] AC-4 Секреты не хранятся в репозитории; есть шаблон `.env.example`.

### 3.4 Негативные сценарии (обязательные)
- **NS-1:** Отсутствует переменная окружения → понятная ошибка при старте.
- **NS-2:** Миграция не применилась → деплой откатывается/останавливается без частичного релиза.

---

## 4) UX / UI (что увидит пользователь)

### 4.1 Изменения экранов/страниц
Не применимо (инфраструктурная фича).

### 4.2 A11y (минимум)
Не применимо.

---

## 5) Архитектура и ответственность слоёв (Clean Architecture)

### 5.1 Компоненты/модули
- **Presentation:** `apps/web`, `apps/admin` (Next.js, TypeScript), `apps/api` (HTTP API), `apps/bot` (Telegram bot service).
- **Application (Use Cases):** в `apps/api/src/application/*` (оркестрация сценариев).
- **Domain:** в `apps/api/src/domain/*` (Aggregates/VO/Events/Repository interfaces) по `docs/Domain-Model-Specification.md`.
- **Infrastructure:** `apps/api/src/infrastructure/*` (Postgres repositories, integrations: GCal/YooKassa/TG/Email, encryption, event bus).

> **Технологический минимум (рекомендация):** TypeScript везде; `apps/web` и `apps/admin` на Next.js; `apps/api` — Node.js (NestJS/Fastify) или Next.js API (если решим монолит). Для релиза 1 предпочтителен отдельный `apps/api` для чистых границ.

### 5.2 Основные use cases (сигнатуры)
Не применимо (каркас), но в `apps/api` должны существовать заготовки модулей/папок под use cases из EPIC-04/05/06/07/08.

### 5.3 Доменные события (если нужны)
Не применимо (только каркас EventBus интерфейса + базовые типы).

---

## 6) Модель данных (БД) и миграции

### 6.1 Новые/изменённые сущности
Не добавляем бизнес-сущности (это `FEAT-PLT-02`), но:
- создаём инфраструктуру миграций (директория, инструмент, команда).

### 6.2 P0/P1/P2 классификация данных
Не применимо напрямую, но в каркасе должны быть:
- соглашения для логирования (запрет PII/P2 в логах/аналитике),
- место для encryption service (P2 “в покое”).

### 6.3 Миграции
- **Migration plan:** определить единый механизм (например, Prisma Migrate / Knex / Liquibase) и стандартизировать.
- **Rollback:** поддерживаем откат миграции для prod (минимум — миграции “вперёд” + запрещаем destructive без процедуры).

---

## 7) API / Контракты (если применимо)

### 7.1 Public API (web)
На этом шаге фиксируем базовые:
- `/api/health` (GET) — healthcheck
- `/api/version` (GET) — версия/commit sha

### 7.2 Admin API
Базовый healthcheck для админки (если отдельный сервис).

### 7.3 Интеграции (внешние)
На уровне каркаса — только заглушки и интерфейсы (без реальных токенов):
- Google Calendar, ЮKassa, Telegram Bot API, Email provider.

---

## 8) Tracking / Analytics (по `docs/Tracking-Plan.md`)

### 8.1 События (таблица)
Не внедряем продуктовые события (это `FEAT-AN-01`), но:
- должны быть заложены точки расширения (SDK/адаптер для `track(...)` на web и “истинные” события на backend).

### 8.2 Воронка / метрики успеха
Не применимо.

---

## 9) Security / Privacy / Compliance

### 9.1 Privacy by design (обязательные пункты)
- [ ] `.env` в `.gitignore`, есть `.env.example`.
- [ ] Секреты в CI/CD — только через secret store.
- [ ] В логах по умолчанию редактируются/запрещаются поля P1/P2 (инфраструктурный guardrail).

### 9.2 RBAC и аудит
Не реализуется здесь (см. `FEAT-PLT-03`, `FEAT-PLT-05`).

### 9.3 Кризисный режим (если применимо)
Не применимо.

---

## 10) Надёжность, производительность, деградации

### 10.1 SLA/SLO (если критично)
Заложить базовые healthcheck/readiness endpoints и таймауты HTTP-клиентов для интеграций (по умолчанию).

### 10.2 Retry / idempotency
Подготовить библиотеку/утилиту для idempotency keys (нужно для webhooks ЮKassa и booking).

### 10.3 Деградации (fallback)
Не применимо на уровне UI.

---

## 11) Rollout plan

### 11.1 Фича‑флаг / поэтапное включение
Не применимо.

### 11.2 Миграция данных и обратимость
Не применимо.

### 11.3 Коммуникации (если нужно)
README для разработчиков.

---

## 12) Test plan

### 12.1 Unit tests
- тесты утилит (config validation, redaction, idempotency helper).

### 12.2 Integration tests
- smoke: поднять Postgres, применить миграцию (пустую на этом шаге), проверить `/api/health`.

### 12.3 E2E (критические happy paths)
Не применимо.

### 12.4 Проверка privacy
- [ ] секреты не печатаются в логах CI
- [ ] `.env` не коммитится

### 12.5 A11y smoke
Не применимо.

---

## 13) Open questions / решения

### 13.1 Вопросы
- [ ] Выбор фреймворка для `apps/api` (NestJS vs Fastify/Express vs Next API) — рекомендуется NestJS/Fastify для чистых границ.
- [ ] Выбор инструмента миграций (Prisma/Knex) — должен поддерживать прозрачный audit trail.

### 13.2 Decision log (что и почему решили)
- **2026-01-07:** Стек по умолчанию: TypeScript end-to-end; web/admin на Next.js; API отдельным сервисом для соблюдения Clean Architecture.

