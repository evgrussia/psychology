# Техническая спецификация фичи (Tech Spec)

**Проект:** «Эмоциональный баланс»  
**Версия спеки:** v0.1 (draft)  
**Автор:** Cursor Agent  
**Дата:** 2026-01-07  
**Статус:** draft  

**Feature ID:** `FEAT-PLT-04`  
**Epic:** `EPIC-00`  
**Приоритет:** P0  
**Трекер:** —  

**Оценка реализации агентом Cursor:** ~90k токенов (≤ 270k)

---

## 1) Summary (коротко)

### 1.1 Что делаем
Реализуем хранение медиа (изображения/аудио/PDF) **в локальной файловой системе на VPS** с раздачей через статику (`/media/*`): загрузка через backend (RBAC), хранение метаданных в БД, выдача публичных URL.

### 1.2 Почему сейчас (контекст / метрики / риск)
- **Сигнал/боль:** контент, ритуалы (аудио), медиа‑библиотека админки зависят от медиа-хранилища.
- **Ожидаемый эффект:** быстрый контент‑поток, **с хранением файлов на сервере** (целевой деплой — обычный VPS).
- **Если не сделать:** блокируется `FEAT-CNT-01`, `FEAT-INT-05`, часть админки.

### 1.3 Ссылки на первоисточники
- Technical decisions: `docs/Technical-Decisions.md` (media storage)
- Data model: `docs/Модель-данных.md` (MEDIA_ASSETS)
- Admin spec: `docs/Admin-Panel-Specification.md` (медиа-библиотека FR-ADM-12)

---

## 2) Goals / Non-goals

### 2.1 Goals (что обязательно)
- **G1:** Upload flow: админ загружает файл → файл сохраняется в каталог медиа на VPS → создаётся запись `media_assets` → возвращается публичный URL.
- **G2:** Права: загрузка только admin roles; удаление с проверкой “используется ли в контенте”.
- **G3:** Поддержка типов: `image/*`, `audio/*`, `application/pdf` (минимум).
- **G4:** Метаданные: title, alt_text, mime, size, object_key.

### 2.2 Non-goals (что осознанно НЕ делаем)
- **NG1:** Полноценный CDN/трансформации изображений (можно позже).
- **NG2:** Видеохостинг.

---

## 3) Scope (границы и сценарии)

### 3.1 In-scope (конкретные сценарии)
- **US-1:** Editor загружает изображение, задаёт alt, вставляет в markdown статьи.
- **US-2:** Owner загружает аудио для мини‑ритуала.
- **US-3:** Пользователь публично видит медиа по URL.

### 3.2 Out-of-scope
- Генерация нескольких размеров изображений (responsive) — можно добавить позже.

### 3.3 Acceptance criteria (AC)
- [ ] AC-1 Есть API для загрузки файла через backend (multipart/form-data).
- [ ] AC-2 Файл проверяется по mime/размеру до загрузки.
- [ ] AC-3 После загрузки запись в БД связана с файлом в локальном хранилище (через `object_key` как относительный путь).
- [ ] AC-4 Удаление медиа запрещено, если есть ссылки из контента (или требует forced unlink).

### 3.4 Негативные сценарии (обязательные)
- **NS-1:** Неподдерживаемый тип файла → 400, без загрузки.
- **NS-2:** Диск/файловая система недоступны (ошибка записи) → корректная ошибка, без “битых” записей (или transactional cleanup).

---

## 4) UX / UI (что увидит пользователь)

### 4.1 Изменения экранов/страниц
Реализуется как платформа для `FEAT-CNT-01` (медиа‑библиотека в админке).

### 4.2 A11y (минимум)
- [ ] Поле alt‑текста обязательно для изображений (или явный чек “декоративное”).

---

## 5) Архитектура и ответственность слоёв (Clean Architecture)

### 5.1 Компоненты/модули
- **Presentation:** admin endpoints `/admin/media/*`.
- **Application:** use cases:
  - `UploadMediaAssetUseCase` (загрузка файла + запись метаданных)
  - `DeleteMediaAssetUseCase`
- **Domain:** `MediaAsset` (может быть частью Content bounded context).
- **Infrastructure:** filesystem storage adapter (локальный диск), DB repository, конфиг статики (Nginx/Caddy или serve-static).

### 5.2 Основные use cases (сигнатуры)
- `UploadMediaAssetUseCase.execute({ filename, mimeType, sizeBytes, file }): { mediaAssetId, publicUrl }`
- `DeleteMediaAssetUseCase.execute({ mediaAssetId }): void`

### 5.3 Доменные события (если нужны)
- `MediaAssetUploaded`, `MediaAssetDeleted` (для audit/analytics).

---

## 6) Модель данных (БД) и миграции

### 6.1 Новые/изменённые сущности
По `docs/Модель-данных.md`:
- `media_assets` (+ связка `content_media`).

### 6.2 P0/P1/P2 классификация данных
- **P0:** mime/type/size/object_key/public_url.
- **P1:** uploaded_by_user_id (внутренний id).
- **P2:** не хранится.

### 6.3 Миграции
Если `media_assets` уже в базовой схеме (FEAT-PLT-02) — миграций нет; иначе — добавить.

---

## 7) API / Контракты (если применимо)

### 7.1 Public API (web)
Публичный доступ — только по `public_url` (раздача статики на VPS, при необходимости — CDN/прокси позже).

### 7.2 Admin API
| Endpoint | Method | Role | Назначение |
|---|---:|---|---|
| `/api/admin/media` | POST | owner/editor | загрузить файл (multipart) + создать запись |
| `/api/admin/media` | GET | owner/editor | список/поиск |
| `/api/admin/media/{id}` | DELETE | owner/editor | удалить (если не используется) |

### 7.3 Интеграции (внешние)
- Нет (локальное хранение на VPS).

---

## 8) Tracking / Analytics (по `docs/Tracking-Plan.md`)

### 8.1 События (таблица)
| Event name | Source | Когда срабатывает | Props (P0-only) | Запреты |
|---|---|---|---|---|
| `admin_media_uploaded` | admin/backend | загрузка успешна | `media_type`, `size_bucket` | без имени файла, без URL если это чувствительно |

### 8.2 Воронка / метрики успеха
Не KPI, но мониторим:
- % ошибок загрузки,
- средний размер.

---

## 9) Security / Privacy / Compliance

### 9.1 Privacy by design (обязательные пункты)
- [ ] Не логировать публичные URL вместе с user PII.
- [ ] Не принимать произвольные пути object_key от клиента (только сервер генерирует).

### 9.2 RBAC и аудит
- загрузка/удаление только admin roles; действия пишем в audit log (`FEAT-PLT-05`).

### 9.3 Кризисный режим (если применимо)
Не применимо.

---

## 10) Надёжность, производительность, деградации

### 10.1 SLA/SLO (если критично)
Ограничения:
- max size: image 10MB, audio 50MB, pdf 20MB (значения уточняем).

### 10.2 Retry / idempotency
- `init` должен быть идемпотентен по `checksum+size` в пределах короткого окна (опционально).

### 10.3 Деградации (fallback)
Если запись файла недоступна: показываем ошибку и предлагаем повторить позже; не ломаем редактор контента.

---

## 11) Rollout plan

### 11.1 Фича‑флаг / поэтапное включение
- `media_upload_enabled`: internal → stage → prod.

### 11.2 Миграция данных и обратимость
Не применимо.

### 11.3 Коммуникации (если нужно)
Инструкция админке: alt‑тексты обязательны.

---

## 12) Test plan

### 12.1 Unit tests
- генерация object_key, валидация mime/size.

### 12.2 Integration tests
- upload → публичный GET (через статику) → delete.

### 12.3 E2E (критические happy paths)
- загрузить изображение в админке и увидеть в превью статьи (в рамках `FEAT-CNT-01`).

### 12.4 Проверка privacy
- [ ] не отправляем filename/PII в аналитику

### 12.5 A11y smoke
- [ ] alt‑текст обязателен/объяснён

---

## 13) Open questions / решения

### 13.1 Вопросы
- [ ] Публичность медиа: public-read (статика) vs приватно + авторизованный прокси (для релиза 1 допустим public-read для контентных медиа).
- [ ] Нужны ли signed GET для некоторых файлов (например, материалы после встречи) — скорее да, но это отдельная фича ЛК.

### 13.2 Decision log (что и почему решили)
- **2026-01-07:** используем локальное хранение на VPS; сервер генерирует `object_key` (относительный путь); загрузка только через admin RBAC.

