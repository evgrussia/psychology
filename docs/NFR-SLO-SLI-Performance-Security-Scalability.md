# Требования NFR (SLO/SLI, производительность, безопасность, масштабирование)

**Проект:** «Эмоциональный баланс»  
**Версия:** v1.0 (для релиза 1)  
**Дата:** 2026-01-07  
**Статус:** ✅ Базовые рамки качества зафиксированы

---

## 1) Зачем этот документ

Этот документ задаёт **рамки качества** (Non‑Functional Requirements) для архитектуры и разработки:
- чтобы решения по стеку/инфраструктуре/данным соответствовали целям продукта;
- чтобы “качество” измерялось (через SLI/SLO), а не обсуждалось абстрактно;
- чтобы безопасность и приватность были встроены “по умолчанию”, учитывая риски **152‑ФЗ** и потенциальную трактовку части данных как чувствительных.

---

## 2) Объект качества: что считаем “сервисом”

В терминах SLO/SLI сервис состоит из контуров:
- **Публичный Web (Site)**: главная, лендинги тем, контент, интерактивы (без обязательной авторизации).
- **Backend API**: бизнес‑операции (интерактивы, booking, ЛК, админка), интеграции.
- **Booking**: слоты/бронь + синхронизация с Google Calendar.
- **Payments**: ЮKassa (статусы, вебхуки, идемпотентность).
- **Telegram**: канал + бот (онбординг, серии, консьерж записи, deep links).
- **Admin Panel**: операционка (контент/модерация/CRM/аналитика) + аудит‑лог.
- **Наблюдаемость (Observability)**: логи/метрики/алерты/трейсинг.

---

## 3) Термины (коротко)

- **SLI (Service Level Indicator)**: измеряемый показатель качества (например, p95 latency, error rate).
- **SLO (Service Level Objective)**: целевое значение SLI на период (обычно месяц).
- **Error budget**: допустимый “бюджет ошибок/простоя” в рамках SLO; расходуется осознанно.
- **Availability**: доля успешных запросов/минут доступности (по определению ниже).

---

## 4) SLI: что и как измеряем (определения)

### 4.1 Ключевые пользовательские пути (golden signals)

Для релиза 1 считаем критичными следующие пути:
- **G1 — Быстрый старт пользы**: открытие главной/лендинга темы → запуск интерактива → показ результата.
- **G2 — Запись**: выбор услуги → выбор слота → подтверждение брони → (опционально) оплата/депозит → подтверждение.
- **G3 — Telegram‑связка**: клик CTA “получить план/сохранить” → deep link → успешный старт бота/подписка.
- **G4 — Админ‑операции**: вход в админку → открытие очереди модерации/контента → сохранение изменений.

### 4.2 SLI (минимальный набор)

**Availability (A)** — доля “хороших” запросов:
- “Хороший” запрос = HTTP 2xx/3xx (для Web) или корректный ответ бизнес‑операции (для API) **без** таймаута.
- Период измерения: месяц, окна по 1 минуте (минутная агрегация).

**Latency (L)** — задержка по перцентилям:
- Web: LCP/INP/TTFB (RUM), плюс TTFB по CDN/edge (synthetic).
- API: p50/p95/p99 по endpoint‑группам.

**Error rate (E)**:
- доля 5xx + бизнес‑ошибок класса “unexpected” (невалидный ввод не считается ошибкой сервиса).

**Correctness / Success rate (S)** по ключевым операциям:
- booking: доля успешных подтверждений брони при корректных данных и наличии слота.
- payments: доля корректно обработанных вебхуков и корректно выставленных статусов.
- telegram deep links: доля успешных стартов бота/приземлений на ожидаемый шаг.

**Data durability (D)**:
- RPO/RTO по БД и медиа.

---

## 5) SLO: целевые уровни (релиз 1)

Ниже — **стартовые** SLO для релиза 1. Они консервативны, чтобы не “сломать” темп разработки, но достаточно жёсткие, чтобы не допустить плохого UX и репутационных рисков.

### 5.1 Доступность (Availability)

| Контур | SLI | SLO (месяц) | Комментарий |
|---|---:|---:|---|
| Публичный Web | A_web | **99.9%** | Критично для доверия/SEO. |
| Backend API (public + auth) | A_api | **99.9%** | Включая интерактивы и booking API. |
| Booking (ключевой путь G2) | S_booking | **99.5%** | Успешное подтверждение брони при корректных условиях. |
| Payments (вебхуки/статусы) | S_payments | **99.9%** | Идемпотентная обработка; потери недопустимы. |
| Telegram bot (команды/серии) | A_tg_bot | **99.5%** | Учитывая зависимость от Telegram API. |
| Admin panel | A_admin | **99.5%** | Операционка терпит чуть ниже, но без длительных простоев. |

**Error budget (ориентир):**
- 99.9% ≈ 43 мин “плохих минут” в месяц (30 дней).
- 99.5% ≈ 3 ч 36 мин в месяц.

### 5.2 Производительность (Web)

Цели для **реальных пользователей (RUM)**, мобильный mid‑tier, 4G:
- **LCP p75 ≤ 2.5s** для главной/лендингов тем/статей.
- **INP p75 ≤ 200ms** для интерактивов (шаги/кнопки/переключения).
- **TTFB p95 ≤ 800ms** (включая CDN, без “холодных” редких аномалий).

Цели для **synthetic** (из 1–2 регионов, 1 раз/мин):
- **Web TTFB p95 ≤ 400ms**.
- **Ошибка загрузки страницы (5xx/timeout) ≤ 0.1%**.

### 5.3 Производительность (API)

Для API (p95), при штатной нагрузке:
- **Read‑операции (контент/каталоги/слоты): p95 ≤ 300ms**.
- **Booking: p95 ≤ 800ms** (включая транзакцию и блокировки слота).
- **Webhook endpoints (payments/calendar): p95 ≤ 500ms** (быстро принять/валидировать, тяжёлое — в очередь).
- **Доля 5xx: ≤ 0.1%** на месяц.

---

## 6) Масштабирование и ёмкость (capacity & scalability)

### 6.1 Нагрузочные допущения (релиз 1)

Пока нет точных прогнозов, принимаем для проектирования:
- **Публичный трафик**: до 10–50k pageviews/день (SEO+Telegram).
- **Конкурентность**: 50–200 одновременных пользователей в пике.
- **Booking**: до 20–100 бронирований/день.
- **Админка**: 1–5 активных пользователей.

Эти числа — **допущения** для выбора архитектурных границ (статлесс, очередь, кэш, индексы), а не обещание.

### 6.2 Архитектурные требования к масштабированию (NFR-SCALE)

- **NFR-SCALE-1 (Stateless)**: web/app‑слой статeless; горизонтальное масштабирование без sticky‑sessions.
- **NFR-SCALE-2 (CDN)**: статический контент и медиа отдаются через CDN; изображения — responsive + оптимизация (WebP/AVIF где возможно).
- **NFR-SCALE-3 (Background jobs)**: интеграции (вебхуки, email/Telegram‑отправки, синхронизация календаря, генерация PDF) выполняются асинхронно через очередь задач.
- **NFR-SCALE-4 (DB indices)**: индексация по ключевым фильтрам (слоты/контент/лиды), миграции — версионированы.
- **NFR-SCALE-5 (Rate limiting)**: защита публичных endpoint‑ов от злоупотреблений (включая интерактивы, формы, login).
- **NFR-SCALE-6 (Graceful degradation)**: при деградации внешних сервисов:
  - Telegram недоступен → CTA показывает альтернативу (email/копировать ссылку/позже);
  - Google Calendar недоступен → booking временно переводится в “лист ожидания/оставьте контакт” (без потери данных).

---

## 7) Безопасность и приватность (security & privacy)

### 7.1 Классификация данных (минимум)

- **Public**: статьи, страницы, общие тексты.
- **Internal**: черновики/настройки, служебные логи без ПДн.
- **PII (ПДн)**: имя, телефон/email, идентификаторы аккаунта, платежные идентификаторы, tg_id (если связка есть).
- **Potentially Sensitive**: ответы/результаты интерактивов, дневники, анкеты — могут трактоваться как чувствительные; обращаемся как с данными повышенного риска.

### 7.2 Базовые требования безопасности (NFR-SEC)

- **NFR-SEC-1 (Transport security)**: HTTPS везде, HSTS, запрет mixed content; TLS 1.2+.
- **NFR-SEC-2 (Secrets)**: секреты/ключи/токены только в секрет‑хранилище; запрет на хранение в репозитории/логах.
- **NFR-SEC-3 (Auth)**:
  - пользователю: безопасная сессия/токены, защита от CSRF (если cookie‑based), защита от session fixation;
  - админке: **MFA обязательна** (релиз 1), ограничение по ролям (RBAC).
- **NFR-SEC-4 (Password storage)**: хеширование паролей (например, Argon2id/bcrypt) + уникальная соль; политика минимальной сложности.
- **NFR-SEC-5 (RBAC)**: роли и права строго на сервере (не только в UI); принцип наименьших привилегий.
- **NFR-SEC-6 (Audit log)**: аудит‑лог критичных действий (изменение цен/удаления/экспорт/роль/права/настройки оплат/интеграций), неизменяемость записей (append‑only).
- **NFR-SEC-7 (OWASP)**: защита от XSS, CSRF, SSRF, SQLi, IDOR; централизованная валидация входных данных.
- **NFR-SEC-8 (Abuse/DDoS)**: rate limit + базовые антибот‑меры для форм; WAF/защита провайдера — желательны.
- **NFR-SEC-9 (Supply chain)**: регулярный dependency scanning (SCA), запрет уязвимых версий, фиксация lock‑файлов.
- **NFR-SEC-10 (Backups protection)**: бэкапы шифруются, доступны по отдельным ключам/правам, хранятся в отдельном бакете/учётке.

### 7.3 Privacy-by-design (NFR-PRIV)

- **NFR-PRIV-1 (Data minimization)**: интерактивы без обязательного контакта; по возможности хранить **уровни/агрегаты**, а не сырые ответы.
- **NFR-PRIV-2 (No sensitive text in analytics)**: свободный текст (анкеты/дневники/черновики) не отправляется в аналитику и не попадает в логи.
- **NFR-PRIV-3 (Consent separation)**: раздельные согласия (ПДн/коммуникации/публикация отзывов), хранение версии текста согласия.
- **NFR-PRIV-4 (User control)**: экспорт/удаление данных из ЛК; отзыв согласий.
- **NFR-PRIV-5 (Retention)**: сроки хранения по типам данных определены и реализуемы (см. ниже).
- **NFR-PRIV-6 (Provider boundaries)**: в Telegram не передавать чувствительные данные; минимальная связка `tg_id ↔ user_id` и возможность разрыва связи.

---

## 8) Надёжность данных, бэкапы, восстановление (RPO/RTO)

### 8.1 Цели восстановления (релиз 1)

- **NFR-DR-1 (RPO)**: RPO ≤ **24 часа** для БД (ежедневный бэкап).
- **NFR-DR-2 (RTO)**: RTO ≤ **4 часа** для поднятия сервиса после инцидента уровня SEV‑1.
- **NFR-DR-3 (Backups testing)**: тест восстановления **не реже 1 раза в месяц**.
- **NFR-DR-4 (Media durability)**: медиа в локальном каталоге на VPS + ежедневные offsite-бэкапы (желательно инкрементальные) и регулярная проверка восстановления.

### 8.2 Идемпотентность и согласованность (NFR-REL)

- **NFR-REL-1 (Payments idempotency)**: вебхуки ЮKassa обрабатываются идемпотентно (по `payment_id`/`event_id`), повторная доставка не ломает состояние.
- **NFR-REL-2 (Booking concurrency)**: защита от гонок на слот (транзакции/локи/уникальные ограничения), чтобы один слот нельзя было подтвердить дважды.
- **NFR-REL-3 (Outbox/queue)**: внешние вызовы (email/Telegram/календарь) — через надёжную очередь/ретраи; сбои не приводят к потере бизнес‑событий.

---

## 9) Наблюдаемость (observability) и эксплуатация

### 9.1 Метрики/логи/трейсы (NFR-OBS)

- **NFR-OBS-1 (Structured logs)**: структурированные логи (JSON), корреляция по `request_id`/`trace_id`.
- **NFR-OBS-2 (PII redaction)**: маскирование/редакция ПДн в логах, запрет на логирование токенов/паролей/платёжных данных.
- **NFR-OBS-3 (Metrics)**: метрики по SLI из разделов 4–5 + инфраструктурные (CPU/RAM/DB/queue).
- **NFR-OBS-4 (Tracing)**: распределённый трейcинг для критичных путей (booking/payments/calendar).
- **NFR-OBS-5 (Dashboards)**: минимум 3 дашборда:
  - “Golden paths” (G1–G4),
  - “Errors & latency”,
  - “Integrations health” (Calendar/YooKassa/Telegram).

### 9.2 Алертинг (NFR-ALERT)

- **NFR-ALERT-1**: алерт при выходе за SLO‑порог по A_api/A_web (скользящее окно 5–10 минут).
- **NFR-ALERT-2**: алерт при всплеске 5xx, росте p95, росте ошибок вебхуков.
- **NFR-ALERT-3**: алерт при росте очереди фоновых задач/росте времени обработки.

### 9.3 Инциденты (NFR-OPS)

- **SEV‑1** (нельзя записаться/оплатить/сайт недоступен): реакция ≤ 15 мин, workaround ≤ 60 мин.
- **SEV‑2** (частичная деградация/админка/Telegram): реакция ≤ 60 мин, workaround ≤ 1 рабочий день.
- **Postmortem**: по SEV‑1 всегда, по SEV‑2 выборочно; фиксируем корень, меры, владельца, срок.

---

## 10) Сроки хранения данных (retention) — стартовые правила

> Итоговые сроки должны быть согласованы с юридическими документами (политика/оферта) и фактической моделью бизнеса. Ниже — технические дефолты.

- **Логи приложения** (без ПДн): 30–90 дней.
- **Метрики/агрегаты**: 13 месяцев (для сезонности), без чувствительных текстов.
- **Данные бронирования/платежей**: хранение согласно требованиям бухгалтерии/юридической модели (как минимум статусы и идентификаторы).
- **Дневники/анкеты/свободный текст**: хранить только при явной необходимости; по умолчанию — пользователь может удалить в любой момент; при удалении — физическое удаление/псевдонимизация в разумных пределах.

---

## 11) Границы (что НЕ является целью SLO)

- SLO не гарантируют качество внешних сервисов (Telegram/Google/ЮKassa), но требуют **корректной деградации** и **идемпотентности**.
- SLO не про “идеальный дизайн”; за визуальное качество отвечает UI‑kit и дизайн‑ревью.

---

## 12) Чеклист внедрения (что должно появиться в архитектуре/разработке)

Для релиза 1 обязательно:
- сбор RUM‑метрик (LCP/INP/TTFB) + synthetic мониторинг;
- базовые API‑метрики (latency/error/throughput) + трассировка ключевых путей;
- аудит‑лог в админке и MFA;
- идемпотентность payments и защита от гонок booking;
- ежедневные бэкапы + тест восстановления.

