# Формулы метрик (единые определения)

**Версия:** v0.1 (draft)  
**Дата:** 2026-01-07  
**Основано на:** `docs/PRD.md`, `docs/Tracking-Plan.md`, `docs/user-flows-cjm.md`, `docs/research/05-Booking-Payment-ClientCabinet.md`, `docs/research/06-Telegram-Ecosystem.md`, `docs/research/08-Admin-CRM-Analytics.md`, `docs/research/12-Community-and-Events.md`.

Документ фиксирует **единые определения и формулы** для KPI/воронок/retention и связанных метрик. Цель — чтобы “конверсия/retention” считались одинаково в Web/Backend/Telegram/Admin и в разных отчётах.

---

## 1) Базовые сущности (что именно считаем)

- **Событие (event)**: запись в каталоге событий из `docs/Tracking-Plan.md` с обязательными полями `event_name`, `occurred_at`, `event_id`, `source`, `anonymous_id/user_id/lead_id`, `session_id`.
- **Пользователь (User)**: субъект с `user_id` (после логина). До логина используем `anonymous_id`.
- **Уникальный посетитель (Unique visitor)**: уникальный `anonymous_id` (или `user_id`, если известен) за период.
- **Сессия (Session)**: уникальный `session_id` (правило: **30 минут неактивности = новая сессия**, см. `Tracking-Plan.md`).
- **Лид (Lead)**: субъект с `lead_id` (создаётся при первом “контактном” событии; правило связки — см. `Tracking-Plan.md`).
- **Клиент (Client)**: `user_id`, у которого есть подтверждённая запись/оплата (минимально — событие `booking_confirmed` и/или `booking_paid`, уточняется бизнес‑правилами).

---

## 2) Базовые правила расчёта (обязательно)

### 2.1 Дедупликация и уникальность

- **События** дедуплицируем по `event_id` (а при отсутствии — по стабильному ключу события на стороне источника).
- **Переход по шагу воронки** считаем по **уникальному субъекту** (по умолчанию `lead_id`, иначе `user_id`, иначе `anonymous_id`) и по правилу **“первый факт шага в окне”**.
- Если событие может “стрелять” дважды (особенно `booking_paid`, `booking_confirmed`) — источником истины является backend/webhook (см. `Tracking-Plan.md`).

### 2.2 Время, часовые пояса, окна

- В хранилище аналитики время хранится в **UTC** (`occurred_at`).
- Для дневных метрик используем **“локальный день пользователя”** по `timezone` (если известна), иначе фиксируем дефолт: `Europe/Moscow`.
- Для воронок обязательно задаём **окно конверсии** \(W\): например, 1 день / 7 дней / 30 дней от первого шага.

### 2.3 “Единица анализа” по умолчанию

- Для бизнес‑воронок (booking/payments) единица анализа по умолчанию: **`lead_id`**.  
- Для чисто продуктовых метрик “возврата” (ЛК/дневники) единица анализа: **`user_id`** (если нет — `anonymous_id`).

### 2.4 Срезы (единые измерения для отчётов)

Чтобы отчёты были сопоставимы, для большинства метрик используем одинаковые срезы (если поле доступно в событии):
- `entry_point` (seo/telegram/direct/referral/ads/internal)
- UTM (`utm_source`, `utm_medium`, `utm_campaign`, `utm_content`)
- `topic`, `format`, `support_level` (таксономия из `docs/Tracking-Plan.md` / `docs/research/01-*`)
- `service_slug`, `payment_provider`

---

## 3) Конверсия: общие формулы

### 3.1 Конверсия шага (step conversion)

Для шагов A → B в окне \(W\):

\[
CR_{A \to B}(W)=\frac{\#\{\text{субъектов, достигших }B\text{ в }W\}}{\#\{\text{субъектов, достигших }A\}}
\]

Где “достигших A/B” — это наличие хотя бы одного события‑шага (см. разделы 4–6).

### 3.2 Сквозная конверсия воронки (funnel conversion)

Для воронки A → … → Z в окне \(W\):

\[
CR_{A \to Z}(W)=\frac{\#\{\text{субъектов, достигших }Z\text{ в }W\}}{\#\{\text{субъектов, достигших }A\}}
\]

### 3.3 CTA rate (кликабельность/переход в след. действие)

Для страницы/модуля:

\[
CTA\_rate=\frac{\#\{\text{уникальных субъектов с }cta\_click\}}{\#\{\text{уникальных субъектов, увидевших поверхность}\}}
\]

Примеры “поверхности”: `page_view` конкретного пути, `view_problem_landing`, `trust_block_viewed` (если используем как прокси “увидел”).

### 3.4 DAU/WAU/MAU (на базе определения Active Day)

Если зафиксировано, что такое “активность” (см. раздел 5.2 / 7), то:

\[
DAU(d)=\#\{\text{users с Active Day в день }d\}
\]

\[
WAU(w)=\#\{\text{users с Active Day в неделе }w\}
\]

\[
MAU(m)=\#\{\text{users с Active Day в месяце }m\}
\]

---

## 4) Booking funnel (запись/оплата) — единые определения

**События шагов (Release 1):** см. `docs/Tracking-Plan.md` раздел “Booking & Payments”.

### 4.1 Шаги воронки

- **Step 1 — Start**: `booking_start`
- **Step 2 — Slot selected**: `booking_slot_selected`
- **Step 3 — Paid**: `booking_paid` (только backend/webhook)
- **Step 4 — Confirmed**: `booking_confirmed` (только backend)

### 4.2 Основные конверсии

- **CR visit → booking_start** (окно обычно \(W=1d\) или \(7d\)):
  - числитель: уникальные субъекты с `booking_start`
  - знаменатель: уникальные посетители (`anonymous_id/user_id`) с `page_view` (или иным определением визита, если авто‑сбор выключен)

- **CR booking_start → booking_confirmed**:
  - \(CR_{booking\_start \to booking\_confirmed}(W)\)

- **Step CR внутри booking**:
  - \(CR_{booking\_start \to booking\_slot\_selected}(W)\)
  - \(CR_{booking\_slot\_selected \to booking\_paid}(W)\)
  - \(CR_{booking\_paid \to booking\_confirmed}(W)\)

### 4.3 “Нет слотов” и лист ожидания

- **No-slots rate**:
\[
NoSlotsRate=\frac{\#\{\text{субъектов с }show\_no\_slots\}}{\#\{\text{субъектов с }booking\_start\}}
\]

- **Waitlist conversion**:
\[
CR_{show\_no\_slots \to waitlist\_submitted}=\frac{\#\{\text{субъектов с }waitlist\_submitted\}}{\#\{\text{субъектов с }show\_no\_slots\}}
\]

### 4.4 Ошибки оплаты (наблюдаемость)

- **Payment fail rate**:
\[
FailRate=\frac{\#\{\text{платежей с }payment\_failed\}}{\#\{\text{платежей с }payment\_started\}}
\]

Рекомендуем дополнительно считать по `failure_category`.

---

## 5) Telegram funnel и метрики удержания

**События (Release 1):** `cta_tg_click`, `tg_subscribe_confirmed`, `tg_onboarding_completed`, `tg_series_stopped` (см. `docs/Tracking-Plan.md` и `docs/research/06-Telegram-Ecosystem.md`).

### 5.1 Воронка Telegram

- **Step 1**: `cta_tg_click` (web)
- **Step 2**: `tg_subscribe_confirmed` (telegram)
- **Step 3**: `tg_onboarding_completed` (telegram)

Конверсии считаем по формулам раздела 3, единица анализа — `deep_link_id`+субъект (чтобы различать разные CTA‑флоу), либо `lead_id` при наличии.

Дополнительно (сквозная конверсия TG → booking):
- **TG → booking_start**: доля субъектов с `booking_start`, у которых `utm_source=telegram` **или** совпал `deep_link_id`.
- **TG → booking_paid**: аналогично, но по `booking_paid` (backend).

### 5.2 Retention в Telegram (D1/D7/D30)

**Когорта \(D0\)**: пользователи, у которых случилось `tg_subscribe_confirmed` (или `tg_onboarding_completed`, если подписка недоступна как факт).

**Активность (Telegram Active Day)** (минимум, измеримый в релизе 1): событие `tg_interaction` (см. `docs/Tracking-Plan.md`) или завершение онбординга `tg_onboarding_completed`.

Тогда:

\[
Dk\ Retention=\frac{\#\{\text{пользователей когорты D0 с Telegram Active Day на }Dk\}}{\#\{\text{пользователей в когорте D0}\}}
\]

Если на релизе 1 нет событий “взаимодействия”, retention будет искажён (считать нечем) — тогда фиксируем только **activation** (`tg_onboarding_completed / tg_subscribe_confirmed`) и **stop rate**.

### 5.3 Stop/unsubscribe (анти‑спам контроль)

- **Stop rate по флоу**:
\[
StopRate=\frac{\#\{\text{пользователей с }tg\_series\_stopped\}}{\#\{\text{пользователей, вошедших во флоу}\}}
\]

Где “вошедших во флоу” — по `tg_flow`/`deep_link_id`.

---

## 6) Interactive funnel (квизы/первый шаг) и ценность

### 6.1 Completion rate квиза

\[
QuizCompletionRate=\frac{\#\{\text{субъектов с }complete\_quiz\}}{\#\{\text{субъектов с }start\_quiz\}}
\]

Срезы: `quiz_slug`, `topic`, `result_level`.

### 6.2 CTA rate после интерактива

- **Quiz → booking_start**:
  - \(CR_{complete\_quiz \to booking\_start}(W)\)
- **Quiz → Telegram**:
  - \(CR_{complete\_quiz \to cta\_tg\_click}(W)\)

### 6.3 First step (упражнение) completion

\[
FirstStepCompletionRate=\frac{\#\{\text{субъектов с }first\_step\_completed\}}{\#\{\text{субъектов с }first\_step\_started\}}
\]

---

## 7) Retention в продукте (ЛК/дневники) — единые определения

**Когорта \(D0\)** (выбираем один вариант и фиксируем в дашбордах):

- **Вариант A (client retention)**: пользователи, у которых есть `booking_confirmed` (или первый “платёж” `booking_paid`).
- **Вариант B (product retention)**: пользователи, у которых случилось “значимое действие” (activation), например `diary_entry_created` или `pdf_exported`.

**Активность (Product Active Day)**: любое из событий:
- `lk_opened`
- `diary_entry_created`
- `pdf_exported`
- (опционально) другие “полезные” действия без чувствительных данных

Тогда D1/D7/D30:

\[
Dk\ Retention=\frac{\#\{\text{users из когорты D0 с Product Active Day на }Dk\}}{\#\{\text{users в когорте D0}\}}
\]

**Важно:** если когорта определяется как “клиенты”, считать retention по `user_id` (а не `anonymous_id`).

---

## 8) No-show rate (неявки) — определение и требуемые данные

PRD требует “no-show rate”, но в каталоге событий релиза 1 пока нет явного “attended/no_show”.

**Единое определение:**

\[
NoShowRate=\frac{\#\{\text{подтверждённых встреч, где клиент не пришёл}\}}{\#\{\text{подтверждённых встреч}\}}
\]

Чтобы метрика была измерима, нужен источник истины (календарь/админка) и хотя бы одно событие:
- `appointment_outcome_recorded` с `outcome=attended|no_show|...` (см. `docs/Tracking-Plan.md`)

До внедрения этого события метрику **не публикуем**, чтобы не считать по прокси.

---

## 9) Выручка и платежи (если считаем в аналитике)

На основе `booking_paid` (истина — backend):

- **GMV (выручка/оборот)**:
\[
GMV=\sum amount \text{ по событиям }booking\_paid
\]

- **AOV (средний чек)**:
\[
AOV=\frac{GMV}{\#\{booking\_paid\}}
\]

Опционально (если появятся refunds): refund rate, net revenue.

### 9.1 CAC и LTV (опционально, если есть данные по затратам/маржинальности)

Эти метрики требуют данных вне event‑трекинга (затраты на канал, себестоимость, возвраты/возмещения).

- **CAC (по каналу)**:
\[
CAC=\frac{\text{затраты на канал за период}}{\#\{\text{новых клиентов из канала за период}\}}
\]

- **LTV (упрощённо, по платежам)**:
\[
LTV=\frac{\sum amount \text{ по }booking\_paid \text{ для когорты}}{\#\{\text{клиентов в когорте}\}}
\]

Важно: в RU‑контексте “выручка” ≠ “прибыль”; для юнит‑экономики нужно явно договориться о том, считаем ли **gross** или **net**.

---

## 10) Короткий словарь (единые термины)

- **Visit**: уникальный посетитель (unique visitor) за период; при необходимости отдельно считаем **sessions**.
- **Conversion**: доля уникальных субъектов, дошедших до шага/цели (в заданном окне \(W\)).
- **Activation**: первое “значимое действие” (в релизе 1 — завершение интерактива/онбординга TG/первого шага).
- **Retention Dk**: доля пользователей когорты D0, которые были активны в день \(Dk\).
- **Churn**: доля ушедших из подписки/клуба за период (см. `docs/research/12-*`; точная формула зависит от модели подписки).

